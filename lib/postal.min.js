/**
 * postal - Pub/Sub library providing wildcard subscriptions, complex message handling, etc.  Works server and client-side.
 * Author: Jim Cowart (http://freshbrewedcode.com/jimcowart)
 * Version: v0.11.2
 * Url: http://github.com/postaljs/postal.js
 * License(s): MIT
 */
(function(n,t){"function"==typeof define&&define.amd?define(["lodash"],function(e){return t(e,n)}):"object"==typeof module&&module.exports?module.exports=t(require("lodash"),this):n.postal=t(n._,n)})(this,function(n,t,e){function i(n,t){return function(){if(console.warn||console.log){var e="Warning, the "+n+" method has been deprecated. Please use "+t+" instead.";console.warn?console.warn(e):console.log(e)}return f.prototype[t].apply(this,arguments)}}function r(){for(;_.length;)u.unsubscribe(_.shift())}function c(n,t,e){return function(i,r,c){i===n&&c.splice(r,1),0===c.length&&delete e[t]}}function s(n,t,e,i,r){return function(c){n.resolver.compare(c.topic,t)&&(e.push(c),c.cacheKeys.push(i),r&&r(c))}}function o(n,t){return{channel:u.configuration.SYSTEM_CHANNEL,topic:"subscription."+n,data:{event:"subscription."+n,channel:t.channel,topic:t.topic}}}function a(t,e){return"function"==typeof t?t:t?function(i){var r=0,c=0;return n.each(t,function(n,s){r+=1,("topic"===s&&e.compare(i.topic,t.topic)||"context"===s&&t.context===i._context||i[s]===t[s])&&(c+=1)}),r===c}:function(){return!0}}var u,h=t.postal,l=function(n,t){this.bus=t,this.channel=n||u.configuration.DEFAULT_CHANNEL};l.prototype.subscribe=function(){return this.bus.subscribe({channel:this.channel,topic:1===arguments.length?arguments[0].topic:arguments[0],callback:1===arguments.length?arguments[0].callback:arguments[1]})},l.prototype.publish=function(){var n=1===arguments.length?"[object String]"===Object.prototype.toString.call(arguments[0])?{topic:arguments[0]}:arguments[0]:{topic:arguments[0],data:arguments[1]};n.channel=this.channel,this.bus.publish(n)};var f=function(n,t,i){if(3!==arguments.length)throw new Error("You must provide a channel, topic and callback when creating a SubscriptionDefinition instance.");if(0===t.length)throw new Error("Topics cannot be empty");this.channel=n,this.topic=t,this.callback=i,this.pipeline=[],this.cacheKeys=[],this._context=e},p=function(){var t;return function(e){var i=!1;return n.isString(e)?(i=e===t,t=e):(i=n.isEqual(e,t),t=n.clone(e)),!i}},b=function(){var t=[];return function(e){var i=!n.any(t,function(t){return n.isObject(e)||n.isArray(e)?n.isEqual(e,t):e===t});return i&&t.push(e),i}};f.prototype={"catch":function(n){var t=this.callback,e=function(){try{t.apply(this,arguments)}catch(e){n(e,arguments[0])}};return this.callback=e,this},defer:function(){return this.delay(0)},disposeAfter:function(t){if(!n.isNumber(t)||0>=t)throw new Error("The value provided to disposeAfter (maxCalls) must be a number greater than zero.");var e=this,i=n.after(t,n.bind(function(){e.unsubscribe()}));return e.pipeline.push(function(n,t,e){e(n,t),i()}),e},distinct:function(){return this.constraint(new b)},distinctUntilChanged:function(){return this.constraint(new p)},invokeSubscriber:function(n,t){if(!this.inactive){var e=this,i=e.pipeline,r=i.length,c=e._context,s=-1;if(r){i=i.concat([e.callback]);var o=function a(n,t){s+=1,r>s?i[s].call(c,n,t,a):e.callback.call(c,n,t)};o(n,t,0)}else e.callback.call(c,n,t)}},logError:function(){if(console){var n;n=console.warn?console.warn:console.log,this["catch"](n)}return this},once:function(){return this.disposeAfter(1)},subscribe:function(n){return this.callback=n,this},unsubscribe:function(){this.inactive||u.unsubscribe(this)},constraint:function(t){if(!n.isFunction(t))throw new Error("Predicate constraint must be a function");return this.pipeline.push(function(n,e,i){t.call(this,n,e)&&i(n,e)}),this},constraints:function(t){var e=this;return n.isArray(t)&&n.each(t,function(n){e.constraint(n)}),e},context:function(n){return this._context=n,this},debounce:function(t,e){if(!n.isNumber(t))throw new Error("Milliseconds must be a number");return this.pipeline.push(n.debounce(function(n,t,e){e(n,t)},t,!!e)),this},delay:function(t){if(!n.isNumber(t))throw new Error("Milliseconds must be a number");var e=this;return e.pipeline.push(function(n,e,i){setTimeout(function(){i(n,e)},t)}),this},throttle:function(t){if(!n.isNumber(t))throw new Error("Milliseconds must be a number");var e=function(n,t,e){e(n,t)};return this.pipeline.push(n.throttle(e,t)),this}};for(var d=["withConstraint","withConstraints","withContext","withDebounce","withDelay","withThrottle"],g=["constraint","constraints","context","debounce","delay","throttle"],m=0;6>m;m++){var v=d[m];f.prototype[v]=i(v,g[m])}var w={cache:{},regex:{},compare:function(t,e){var i,r,c,s=this.cache[e+"-"+t];return s===!0?s:-1===t.indexOf("#")&&-1===t.indexOf("*")?s=this.cache[e+"-"+t]=e===t:((r=this.regex[t])||(i="^"+n.map(t.split("."),function(n){var t="";return c&&(t="#"!==c?"\\.\\b":"\\b"),t+="#"===n?"[\\s\\S]*":"*"===n?"[^.]+":n,c=n,t}).join("")+"$",r=this.regex[t]=new RegExp(i)),s=this.cache[e+"-"+t]=r.test(e))},reset:function(){this.cache={},this.regex={}},purge:function(t){t?n.each(this.cache,function(n,e){var i=e.split("-"),r=i[0],c=i[1];(t.topic&&t.topic===r||t.binding&&t.binding===c)&&delete this.cache[e]},this):this.reset()}},y=0,_=[],E=n.bind(o,this,"created"),S=n.bind(o,this,"removed");if(u={cache:{},configuration:{resolver:w,DEFAULT_CHANNEL:"/",SYSTEM_CHANNEL:"postal",enableSystemMessages:!0,cacheKeyDelimiter:"|"},subscriptions:{},wireTaps:[],ChannelDefinition:l,SubscriptionDefinition:f,channel:function(n){return new l(n,this)},addWireTap:function(n){var t=this;return t.wireTaps.push(n),function(){var e=t.wireTaps.indexOf(n);-1!==e&&t.wireTaps.splice(e,1)}},noConflict:function(){if("undefined"==typeof window||"undefined"!=typeof window&&"function"==typeof define&&define.amd)throw new Error("noConflict can only be used in browser clients which aren't using AMD modules");return t.postal=h,this},getSubscribersFor:function(t){var e=[],i=this;return n.each(i.subscriptions,function(r){n.each(r,function(r){e=e.concat(n.filter(r,a(t,i.configuration.resolver)))})}),e},publish:function(t){++y;var e=this.configuration,i=t.channel=t.channel||e.DEFAULT_CHANNEL,c=t.topic;t.timeStamp=new Date,this.wireTaps.length&&n.each(this.wireTaps,function(n){n(t.data,t,y)});var o=i+e.cacheKeyDelimiter+c,a=this.cache[o];if(a)n.each(a,function(n){n.invokeSubscriber(t.data,t)});else{a=this.cache[o]=[];var u=s(e,c,a,o,function(n){n.invokeSubscriber(t.data,t)});n.each(this.subscriptions[i],function(t){n.each(t,u)})}0===--y&&r()},reset:function(){this.unsubscribeFor(),this.configuration.resolver.reset(),this.subscriptions={}},subscribe:function(t){var e,i=this.subscriptions,r=new f(t.channel||this.configuration.DEFAULT_CHANNEL,t.topic,t.callback),c=i[r.channel],o=r.channel.length,a=this.configuration;return c||(c=i[r.channel]={}),e=i[r.channel][r.topic],e||(e=i[r.channel][r.topic]=[]),e.push(r),n.each(this.cache,function(n,t){t.substr(0,o)===r.channel&&s(a,t.split(a.cacheKeyDelimiter)[1],n,t)(r)}),this.configuration.enableSystemMessages&&this.publish(E(r)),r},unsubscribe:function(){for(var t,e,i,r,s=arguments.length,o=0;s>o;o++){if(t=arguments[o],t.inactive=!0,y)return _.push(t),void 0;if(e=this.subscriptions[t.channel],i=e&&e[t.topic]){var a=i.length;for(r=0;a>r;){if(i[r]===t){i.splice(r,1);break}r+=1}if(0===i.length&&(delete e[t.topic],n.isEmpty(e)&&delete this.subscriptions[t.channel]),t.cacheKeys&&t.cacheKeys.length)for(var u;u=t.cacheKeys.pop();)n.each(this.cache[u],c(t,u,this.cache))}this.configuration.enableSystemMessages&&this.publish(S(t))}},unsubscribeFor:function(n){var t=[];this.subscriptions&&(t=this.getSubscribersFor(n),this.unsubscribe.apply(this,t))}},u.subscriptions[u.configuration.SYSTEM_CHANNEL]={},t&&Object.prototype.hasOwnProperty.call(t,"__postalReady__")&&n.isArray(t.__postalReady__))for(;t.__postalReady__.length;)t.__postalReady__.shift().onReady(u);return u});